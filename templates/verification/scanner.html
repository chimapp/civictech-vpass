{% extends "base.html" %}

{% block title %}驗證 - {{ event.event_name }}{% endblock %}

{% block container_class %}container-xl{% endblock %}

{% block content %}
<div class="page-header animate-fade-in">
    <nav class="breadcrumb-nav">
        <a href="/verify" class="breadcrumb-link">← 返回活動</a>
    </nav>
    <div class="page-header-content">
        <div class="page-header-text">
            <h1 class="page-title">{{ event.event_name }}</h1>
            <p class="page-subtitle">{{ issuer.channel_name }}</p>
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 360px 1fr; gap: 2rem; margin-top: 2rem;">
    <!-- Left Sidebar: Instructions -->
    <div class="animate-fade-in stagger-1" style="display: flex; flex-direction: column; gap: 1.5rem;">
        <div style="background: white; border: 1px solid var(--color-mist); border-radius: 12px; padding: 1.5rem;">
            <h2 style="font-family: var(--font-display); font-size: 1.25rem; font-weight: 700; color: var(--color-ink); margin-bottom: 1.25rem; letter-spacing: -0.02em;">驗證步驟</h2>

            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div style="display: flex; gap: 1rem;">
                    <div class="section-number" style="width: 36px; height: 36px; font-size: 1rem; flex-shrink: 0;">01</div>
                    <p style="color: var(--color-slate); font-size: 0.9375rem; line-height: 1.6; margin: 0;">
                        在手機上開啟數位皮夾應用程式
                    </p>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <div class="section-number" style="width: 36px; height: 36px; font-size: 1rem; flex-shrink: 0;">02</div>
                    <p style="color: var(--color-slate); font-size: 0.9375rem; line-height: 1.6; margin: 0;">
                        向參與者展示右側的 QR Code
                    </p>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <div class="section-number" style="width: 36px; height: 36px; font-size: 1rem; flex-shrink: 0;">03</div>
                    <p style="color: var(--color-slate); font-size: 0.9375rem; line-height: 1.6; margin: 0;">
                        請他們使用數位皮夾應用程式掃描
                    </p>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <div class="section-number" style="width: 36px; height: 36px; font-size: 1rem; flex-shrink: 0;">04</div>
                    <p style="color: var(--color-slate); font-size: 0.9375rem; line-height: 1.6; margin: 0;">
                        等待驗證結果出現
                    </p>
                </div>
            </div>
        </div>

        <a href="/verify/{{ event.id }}/history" class="btn btn-ghost" style="width: 100%; justify-content: center;">
            <i class="bi bi-clock-history"></i>
            <span>查看驗證歷史記錄</span>
        </a>
    </div>

    <!-- Right Panel: QR Viewer & Results -->
    <div class="animate-fade-in stagger-2">
        <!-- QR Code Section -->
        <div id="qr-container" style="background: white; border: 2px solid var(--color-mist); border-radius: 16px; padding: 3rem; margin-bottom: 2rem;">
            <div id="loading" class="text-center" style="padding: 3rem 0;">
                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p style="color: var(--color-slate); font-weight: 600; font-size: 1.125rem; margin: 0;">產生 QR Code 中...</p>
            </div>

            <div id="qr-display" class="text-center" hidden>
                <div class="qr-viewer" style="margin: 0 auto;">
                    <img id="qr-image" class="qr-code-image" alt="驗證 QR Code">
                </div>
                <div class="qr-countdown" style="margin-top: 2rem;">
                    <div style="font-size: 0.875rem; color: var(--color-slate); margin-bottom: 0.5rem;">到期時間</div>
                    <div id="countdown" style="font-family: var(--font-display); font-size: 2.5rem; font-weight: 800; color: var(--color-ink);">5:00</div>
                </div>
                <button id="refresh-btn" type="button" class="btn btn-primary btn-lg" style="margin-top: 2rem;" hidden onclick="requestNewQR()">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span>產生新的 QR Code</span>
                </button>
            </div>
        </div>

        <!-- Result Section -->
        <div id="result-container">
            <div id="pending-status" class="verification-result" style="background: rgba(0, 217, 255, 0.06); border: 2px solid rgba(0, 217, 255, 0.2);" hidden>
                <div class="result-icon" style="color: var(--color-cyan); animation: pulse-status 2s ease-in-out infinite;">
                    <i class="bi bi-qr-code-scan"></i>
                </div>
                <h3 class="result-title" style="color: var(--color-cyan);">等待掃描中...</h3>
                <p class="result-message">請參與者掃描上方 QR Code</p>
            </div>

            <div id="success-result" class="verification-result result-success" hidden>
                <div class="result-icon">
                    <i class="bi bi-check-circle-fill"></i>
                </div>
                <h3 class="result-title">驗證成功</h3>
                <div id="member-info" class="member-info"></div>
                <button type="button" class="btn btn-primary btn-lg" onclick="requestNewQR()">
                    <i class="bi bi-arrow-right-circle-fill"></i>
                    <span>驗證下一位</span>
                </button>
            </div>

            <div id="failed-result" class="verification-result result-error" hidden>
                <div class="result-icon">
                    <i class="bi bi-x-circle-fill"></i>
                </div>
                <h3 class="result-title">驗證失敗</h3>
                <p id="error-message" class="result-message"></p>
                <button type="button" class="btn btn-secondary btn-lg" onclick="requestNewQR()">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span>再試一次</span>
                </button>
            </div>

            <div id="expired-result" class="verification-result" style="background: rgba(245, 158, 11, 0.08); border: 2px solid rgba(245, 158, 11, 0.3);" hidden>
                <div class="result-icon" style="color: #f59e0b;">
                    <i class="bi bi-clock-history"></i>
                </div>
                <h3 class="result-title" style="color: #f59e0b;">QR Code 已過期</h3>
                <p class="result-message">為了安全，QR Code 會在 5 分鐘後過期</p>
                <button type="button" class="btn btn-accent btn-lg" onclick="requestNewQR()">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span>產生新的 QR Code</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Responsive Layout for Mobile -->
<style>
@media (max-width: 1200px) {
    div[style*="grid-template-columns: 360px 1fr"] {
        grid-template-columns: 1fr !important;
    }
}
</style>

<script>
const eventId = "{{ event.id }}";
let transactionId = null;
let pollInterval = null;
let expiresAt = null;
let countdownInterval = null;

function showElement(id) {
    const el = document.getElementById(id);
    if (el) {
        el.hidden = false;
    }
}

function hideElement(id) {
    const el = document.getElementById(id);
    if (el) {
        el.hidden = true;
    }
}

// Initialize: Request QR code on page load
window.onload = function() {
    requestNewQR();
};

async function requestNewQR() {
    // Clear any existing intervals
    if (pollInterval) clearInterval(pollInterval);
    if (countdownInterval) clearInterval(countdownInterval);

    // Reset UI
    showElement('loading');
    hideElement('qr-display');
    hideElement('pending-status');
    hideElement('success-result');
    hideElement('failed-result');
    hideElement('expired-result');
    hideElement('refresh-btn');

    try {
        const response = await fetch(`/verify/${eventId}/request-qr`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${await response.text()}`);
        }

        const data = await response.json();
        transactionId = data.transaction_id;
        expiresAt = Date.now() + (data.expires_in_seconds * 1000);

        // Display QR code
        document.getElementById('qr-image').src = `data:image/png;base64,${data.qrcode_image}`;
        hideElement('loading');
        showElement('qr-display');
        showElement('pending-status');

        // Start countdown timer
        startCountdown();

        // Start polling for result
        pollInterval = setInterval(checkResult, 2000); // Poll every 2 seconds

    } catch (error) {
        console.error('Failed to request QR code:', error);
        const loading = document.getElementById('loading');
        loading.innerHTML = `
            <div style="padding: 3rem 0;">
                <div style="font-size: 3rem; color: var(--color-coral); margin-bottom: 1rem;">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                </div>
                <p style="color: var(--color-ink); font-weight: 600; font-size: 1.125rem; margin-bottom: 0.5rem;">無法產生 QR Code</p>
                <p style="color: var(--color-slate); font-size: 0.9375rem; margin-bottom: 2rem;">${error.message}</p>
                <button type="button" class="btn btn-secondary" onclick="requestNewQR()">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span>重試</span>
                </button>
            </div>
        `;
    }
}

function startCountdown() {
    updateCountdown();
    countdownInterval = setInterval(updateCountdown, 1000);
}

function updateCountdown() {
    const remaining = Math.max(0, expiresAt - Date.now());
    const minutes = Math.floor(remaining / 60000);
    const seconds = Math.floor((remaining % 60000) / 1000);

    const countdownEl = document.getElementById('countdown');
    if (countdownEl) {
        countdownEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

        // Change color when less than 30 seconds
        if (remaining < 30000) {
            countdownEl.style.color = 'var(--color-coral)';
        } else {
            countdownEl.style.color = 'var(--color-ink)';
        }
    }

    if (remaining <= 0) {
        clearInterval(countdownInterval);
        clearInterval(pollInterval);
        showElement('refresh-btn');
    }
}

async function checkResult() {
    if (!transactionId) return;

    try {
        const response = await fetch(`/verify/${eventId}/check-result/${transactionId}`);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const result = await response.json();

        if (result.status === 'completed') {
            clearInterval(pollInterval);
            clearInterval(countdownInterval);
            displayResult(result);
        } else if (result.status === 'expired') {
            clearInterval(pollInterval);
            clearInterval(countdownInterval);
            showExpired();
        }
        // If status is 'pending', continue polling

    } catch (error) {
        console.error('Failed to check result:', error);
        // Continue polling on error
    }
}

function displayResult(result) {
    hideElement('pending-status');
    hideElement('qr-display');

    if (result.verify_result === true) {
        // Success
        showElement('success-result');

        // Display member info if available
        if (result.member_info) {
            const memberInfoDiv = document.getElementById('member-info');
            memberInfoDiv.innerHTML = '';

            const dl = document.createElement('dl');
            dl.style.cssText = 'display: grid; gap: 0.75rem; text-align: left; margin: 0;';

            for (const [key, value] of Object.entries(result.member_info)) {
                if (key !== 'credentialType') {
                    const div = document.createElement('div');
                    const dt = document.createElement('dt');
                    dt.style.cssText = 'font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--color-cyan); margin-bottom: 0.25rem;';
                    dt.textContent = key;
                    const dd = document.createElement('dd');
                    dd.style.cssText = 'font-size: 1rem; color: var(--color-ink); font-weight: 500; margin: 0;';
                    dd.textContent = value;
                    div.appendChild(dt);
                    div.appendChild(dd);
                    dl.appendChild(div);
                }
            }
            memberInfoDiv.appendChild(dl);
        }
    } else {
        // Failed
        showElement('failed-result');
        document.getElementById('error-message').textContent =
            result.result_description || '驗證失敗';
    }
}

function showExpired() {
    hideElement('pending-status');
    hideElement('qr-display');
    showElement('expired-result');
}
</script>
{% endblock %}
