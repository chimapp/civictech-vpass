{% extends "base.html" %}

{% block title %}驗證 - {{ event.event_name }}{% endblock %}

{% block content %}
<section>
    <nav aria-label="上一頁">
        <a href="/verify">&larr; 返回活動</a>
    </nav>

    <header>
        <h1>{{ event.event_name }}</h1>
        <p>{{ issuer.channel_name }}</p>
    </header>

    <section id="instructions" aria-label="驗證步驟">
        <h2>如何驗證會員身份</h2>
        <ol>
            <li>在手機上開啟數位皮夾應用程式。</li>
            <li>向參與者展示下方的 QR Code。</li>
            <li>請他們使用數位皮夾應用程式掃描。</li>
            <li>等待驗證結果出現。</li>
        </ol>
    </section>

    <section id="qr-container" aria-label="驗證 QR Code">
        <div id="loading">
            <p>產生 QR Code 中...</p>
        </div>

        <div id="qr-display" hidden>
            <figure>
                <img id="qr-image" alt="驗證 QR Code">
                <figcaption id="timer">
                    到期時間： <span id="countdown">5:00</span>
                </figcaption>
            </figure>
            <button id="refresh-btn" type="button" hidden onclick="requestNewQR()">產生新的 QR Code</button>
        </div>
    </section>

    <section id="result-container" aria-label="驗證結果">
        <div id="pending-status" hidden>
            <p>等待掃描中...</p>
            <p>請參與者掃描 QR Code</p>
        </div>

        <div id="success-result" hidden>
            <h3>驗證成功</h3>
            <div id="member-info"></div>
            <button type="button" onclick="requestNewQR()">驗證下一位</button>
        </div>

        <div id="failed-result" hidden>
            <h3>驗證失敗</h3>
            <p id="error-message"></p>
            <button type="button" onclick="requestNewQR()">再試一次</button>
        </div>

        <div id="expired-result" hidden>
            <h3>QR Code 已過期</h3>
            <p>為了安全，QR Code 會在 5 分鐘後過期。</p>
            <button type="button" onclick="requestNewQR()">產生新的 QR Code</button>
        </div>
    </section>

    <p>
        <a href="/verify/{{ event.id }}/history">查看驗證歷史記錄</a>
    </p>
</section>

<script>
const eventId = "{{ event.id }}";
let transactionId = null;
let pollInterval = null;
let expiresAt = null;
let countdownInterval = null;

function showElement(id) {
    const el = document.getElementById(id);
    if (el) {
        el.hidden = false;
    }
}

function hideElement(id) {
    const el = document.getElementById(id);
    if (el) {
        el.hidden = true;
    }
}

// Initialize: Request QR code on page load
window.onload = function() {
    requestNewQR();
};

async function requestNewQR() {
    // Clear any existing intervals
    if (pollInterval) clearInterval(pollInterval);
    if (countdownInterval) clearInterval(countdownInterval);

    // Reset UI
    const loadingContainer = document.getElementById('loading');
    if (loadingContainer) {
        loadingContainer.textContent = '';
        const loadingMessage = document.createElement('p');
        loadingMessage.textContent = '產生 QR Code 中...';
        loadingContainer.appendChild(loadingMessage);
    }
    showElement('loading');
    hideElement('qr-display');
    hideElement('pending-status');
    hideElement('success-result');
    hideElement('failed-result');
    hideElement('expired-result');
    hideElement('refresh-btn');

    try {
        const response = await fetch(`/verify/${eventId}/request-qr`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${await response.text()}`);
        }

        const data = await response.json();
        transactionId = data.transaction_id;
        expiresAt = Date.now() + (data.expires_in_seconds * 1000);

        // Display QR code
        document.getElementById('qr-image').src = `data:image/png;base64,${data.qrcode_image}`;
        hideElement('loading');
        showElement('qr-display');
        showElement('pending-status');

        // Start countdown timer
        startCountdown();

        // Start polling for result
        pollInterval = setInterval(checkResult, 2000); // Poll every 2 seconds

    } catch (error) {
        console.error('Failed to request QR code:', error);
        const loading = document.getElementById('loading');
        loading.textContent = '';
        const heading = document.createElement('p');
        heading.textContent = '無法產生 QR Code';
        const details = document.createElement('p');
        details.textContent = error.message;
        const retryButton = document.createElement('button');
        retryButton.type = 'button';
        retryButton.textContent = '重試';
        retryButton.addEventListener('click', requestNewQR);
        loading.appendChild(heading);
        loading.appendChild(details);
        loading.appendChild(retryButton);
    }
}

function startCountdown() {
    updateCountdown();
    countdownInterval = setInterval(updateCountdown, 1000);
}

function updateCountdown() {
    const remaining = Math.max(0, expiresAt - Date.now());
    const minutes = Math.floor(remaining / 60000);
    const seconds = Math.floor((remaining % 60000) / 1000);

    document.getElementById('countdown').textContent =
        `${minutes}:${seconds.toString().padStart(2, '0')}`;

    if (remaining <= 0) {
        clearInterval(countdownInterval);
        clearInterval(pollInterval);
        showElement('refresh-btn');
    }
}

async function checkResult() {
    if (!transactionId) return;

    try {
        const response = await fetch(`/verify/${eventId}/check-result/${transactionId}`);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const result = await response.json();

        if (result.status === 'completed') {
            clearInterval(pollInterval);
            clearInterval(countdownInterval);
            displayResult(result);
        } else if (result.status === 'expired') {
            clearInterval(pollInterval);
            clearInterval(countdownInterval);
            showExpired();
        }
        // If status is 'pending', continue polling

    } catch (error) {
        console.error('Failed to check result:', error);
        // Continue polling on error
    }
}

function displayResult(result) {
    hideElement('pending-status');
    hideElement('qr-display');

    if (result.verify_result === true) {
        // Success
        showElement('success-result');

        // Display member info if available
        if (result.member_info) {
            const memberInfoDiv = document.getElementById('member-info');
            memberInfoDiv.textContent = '';
            const heading = document.createElement('h4');
            heading.textContent = '會員資訊：';
            memberInfoDiv.appendChild(heading);

            for (const [key, value] of Object.entries(result.member_info)) {
                if (key !== 'credentialType') {
                    const item = document.createElement('p');
                    item.textContent = `${key}: ${value}`;
                    memberInfoDiv.appendChild(item);
                }
            }
        }
    } else {
        // Failed
        showElement('failed-result');
        document.getElementById('error-message').textContent =
            result.result_description || 'Verification failed';
    }
}

function showExpired() {
    hideElement('pending-status');
    hideElement('qr-display');
    showElement('expired-result');
}
</script>
{% endblock %}
