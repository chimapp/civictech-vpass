{% extends "base.html" %}

{% block title %}建立發行者 - VPass{% endblock %}

{% block content %}
    <nav aria-label="上一頁">
        <a href="/issuers">返回發行者</a>
    </nav>

    <header>
        <h1>建立發行者</h1>
        <p>註冊新的卡片發行者</p>
    </header>

    <form action="/issuers" method="POST">
        <section aria-label="從 YouTube 快速填寫">
            <h2>從 YouTube 快速填寫</h2>
            <label for="channel_url">頻道網址</label>
            <input type="text" id="channel_url" placeholder="https://www.youtube.com/@Dokibird">
            <button type="button" id="autofill-btn">自動填寫</button>
            <p id="error-message" role="status"></p>
        </section>

        <section aria-label="基本資訊">
            <label for="youtube_channel_id">YouTube Channel ID（必填）</label>
            <input type="text" name="youtube_channel_id" id="youtube_channel_id" required placeholder="UCxxxxxxxxxxxxxxxxxxx">
            <p>YouTube 頻道的唯一識別碼。</p>

            <label for="channel_name">頻道名稱（必填）</label>
            <input type="text" name="channel_name" id="channel_name" required placeholder="我的頻道">

            <label for="channel_handle">頻道代號</label>
            <input type="text" name="channel_handle" id="channel_handle" placeholder="@mychannel">
            <p>選填：頻道的 @ 名字。</p>

            <label for="verification_video_id">驗證影片 ID（必填）</label>
            <input type="text" name="verification_video_id" id="verification_video_id" required placeholder="dQw4w9WgXcQ">
            <p>會員將在此影片發布驗證留言。</p>

            <label for="default_membership_label">預設會員標籤（必填）</label>
            <input type="text" name="default_membership_label" id="default_membership_label" required placeholder="會員" value="會員">
            <p>在卡片上顯示的標籤（例如：「會員」、「訂閱者」）。</p>
        </section>

        <button type="submit">建立發行者</button>
    </form>

    <script>
        document.getElementById('autofill-btn').addEventListener('click', async function() {
            const urlInput = document.getElementById('channel_url');
            const url = urlInput.value.trim();
            const errorDiv = document.getElementById('error-message');
            const btn = this;

            if (!url) {
                errorDiv.textContent = '請輸入 YouTube 頻道網址';
                return;
            }

            errorDiv.textContent = '';
            btn.disabled = true;
            btn.textContent = '載入中...';

            try {
                const response = await fetch(`/issuers/autofill?url=${encodeURIComponent(url)}`);

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(text || '無法取得頻道資訊');
                }

                const data = await response.json();

                document.getElementById('youtube_channel_id').value = data.channel_id;
                document.getElementById('channel_name').value = data.channel_name;
                document.getElementById('channel_handle').value = data.channel_handle;
                urlInput.value = '';

            } catch (error) {
                errorDiv.textContent = error.message;
            } finally {
                btn.disabled = false;
                btn.textContent = '自動填寫';
            }
        });

        document.getElementById('channel_url').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('autofill-btn').click();
            }
        });
    </script>
{% endblock %}
