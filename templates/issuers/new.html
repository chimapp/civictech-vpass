{% extends "base.html" %}

{% block title %}建立發行者 - VPass{% endblock %}

{% block content %}
    <nav aria-label="上一頁" class="mb-3">
        <a class="btn btn-link px-0" href="/issuers">&larr; 返回發行者</a>
    </nav>

    <header class="mb-4">
        <h1 class="h3 mb-1">建立發行者</h1>
        <p class="text-secondary mb-0">註冊新的卡片發行者</p>
    </header>

    <form action="/issuers" method="POST" class="app-section">
        <section aria-label="從 YouTube 快速填寫" class="mb-4">
            <h2 class="h5 mb-3">從 YouTube 快速填寫</h2>
            <div class="row g-2 align-items-end">
                <div class="col-md-8">
                    <label class="form-label" for="channel_url">頻道網址</label>
                    <input type="text" class="form-control" id="channel_url" placeholder="https://www.youtube.com/@Dokibird">
                </div>
                <div class="col-md-4">
                    <button type="button" id="autofill-btn" class="btn btn-outline-primary w-100">自動填寫</button>
                </div>
            </div>
            <div id="error-message" class="alert alert-warning mt-3 d-none" role="status"></div>
        </section>

        <section aria-label="基本資訊" class="row g-3">
            <div class="col-md-6">
                <label class="form-label" for="youtube_channel_id">YouTube Channel ID（必填）</label>
                <input type="text" class="form-control" name="youtube_channel_id" id="youtube_channel_id" required placeholder="UCxxxxxxxxxxxxxxxxxxx">
                <div class="form-text">YouTube 頻道的唯一識別碼。</div>
            </div>

            <div class="col-md-6">
                <label class="form-label" for="channel_name">頻道名稱（必填）</label>
                <input type="text" class="form-control" name="channel_name" id="channel_name" required placeholder="我的頻道">
            </div>

            <div class="col-md-6">
                <label class="form-label" for="channel_handle">頻道代號</label>
                <input type="text" class="form-control" name="channel_handle" id="channel_handle" placeholder="@mychannel">
                <div class="form-text">選填：頻道的 @ 名字。</div>
            </div>

            <div class="col-md-6">
                <label class="form-label" for="verification_video_id">驗證影片 ID（必填）</label>
                <input type="text" class="form-control" name="verification_video_id" id="verification_video_id" required placeholder="dQw4w9WgXcQ">
                <div class="form-text">會員將在此影片發布驗證留言。</div>
            </div>

            <div class="col-md-6">
                <label class="form-label" for="default_membership_label">預設會員標籤（必填）</label>
                <input type="text" class="form-control" name="default_membership_label" id="default_membership_label" required placeholder="會員" value="會員">
                <div class="form-text">在卡片上顯示的標籤（例如：「會員」、「訂閱者」）。</div>
            </div>
        </section>

        <div class="mt-4">
            <button type="submit" class="btn btn-primary w-100">建立發行者</button>
        </div>
    </form>

    <script>
        document.getElementById('autofill-btn').addEventListener('click', async function() {
            const urlInput = document.getElementById('channel_url');
            const url = urlInput.value.trim();
            const errorDiv = document.getElementById('error-message');
            const btn = this;

            if (!url) {
                errorDiv.textContent = '請輸入 YouTube 頻道網址';
                errorDiv.classList.remove('d-none');
                return;
            }

            errorDiv.classList.add('d-none');
            btn.disabled = true;
            btn.textContent = '載入中...';

            try {
                const response = await fetch(`/issuers/autofill?url=${encodeURIComponent(url)}`);

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(text || '無法取得頻道資訊');
                }

                const data = await response.json();

                document.getElementById('youtube_channel_id').value = data.channel_id;
                document.getElementById('channel_name').value = data.channel_name;
                document.getElementById('channel_handle').value = data.channel_handle;
                urlInput.value = '';

            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('d-none');
            } finally {
                btn.disabled = false;
                btn.textContent = '自動填寫';
            }
        });

        document.getElementById('channel_url').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('autofill-btn').click();
            }
        });
    </script>
{% endblock %}
