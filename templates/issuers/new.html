{% extends "base.html" %}

{% block title %}Create Issuer - VPass{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="/static/css/issuer-form.css">
{% endblock %}

{% block content %}
    <a href="/issuers" class="back">Back to Issuers</a>
    <h1>Create Issuer</h1>
    <p class="subtitle">Register a new card issuer</p>

    <form action="/issuers" method="POST">
        <div class="autofill-section">
            <h2>Quick Fill from YouTube</h2>
            <div class="autofill-input-group">
                <input type="text" id="channel_url" placeholder="https://www.youtube.com/@Dokibird">
                <button type="button" id="autofill-btn">Auto-Fill</button>
            </div>
            <div class="error-message" id="error-message"></div>
        </div>

        <div class="form-group">
            <label for="youtube_channel_id">YouTube Channel ID <span class="required">*</span></label>
            <input type="text" name="youtube_channel_id" id="youtube_channel_id" required
                   placeholder="UCxxxxxxxxxxxxxxxxxxx">
            <p class="help-text">The unique identifier for the YouTube channel</p>
        </div>

        <div class="form-group">
            <label for="channel_name">Channel Name <span class="required">*</span></label>
            <input type="text" name="channel_name" id="channel_name" required
                   placeholder="My Awesome Channel">
        </div>

        <div class="form-group">
            <label for="channel_handle">Channel Handle</label>
            <input type="text" name="channel_handle" id="channel_handle"
                   placeholder="@myawesomechannel">
            <p class="help-text">Optional: The @handle for the channel</p>
        </div>

        <div class="form-group">
            <label for="verification_video_id">Verification Video ID <span class="required">*</span></label>
            <input type="text" name="verification_video_id" id="verification_video_id" required
                   placeholder="dQw4w9WgXcQ">
            <p class="help-text">The video ID where members will post verification comments</p>
        </div>

        <div class="form-group">
            <label for="default_membership_label">Default Membership Label <span class="required">*</span></label>
            <input type="text" name="default_membership_label" id="default_membership_label" required
                   placeholder="Member" value="Member">
            <p class="help-text">The label shown on issued cards (e.g., "Member", "Subscriber")</p>
        </div>

        <button type="submit">Create Issuer</button>
    </form>

    <script>
        document.getElementById('autofill-btn').addEventListener('click', async function() {
            const urlInput = document.getElementById('channel_url');
            const url = urlInput.value.trim();
            const errorDiv = document.getElementById('error-message');
            const btn = this;

            if (!url) {
                errorDiv.textContent = 'Please enter a YouTube channel URL';
                errorDiv.style.display = 'block';
                return;
            }

            errorDiv.style.display = 'none';
            btn.disabled = true;
            btn.textContent = 'Loading...';

            try {
                const response = await fetch(`/issuers/autofill?url=${encodeURIComponent(url)}`);

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(text || 'Failed to fetch channel info');
                }

                const data = await response.json();

                document.getElementById('youtube_channel_id').value = data.channel_id;
                document.getElementById('channel_name').value = data.channel_name;
                document.getElementById('channel_handle').value = data.channel_handle;
                urlInput.value = '';

            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Auto-Fill';
            }
        });

        document.getElementById('channel_url').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('autofill-btn').click();
            }
        });
    </script>
{% endblock %}
