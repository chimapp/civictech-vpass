{% extends "base.html" %}

{% block title %}卡片 - VPass{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="/static/css/cards.css">
{% endblock %}

{% block content %}
    <a href="/cards/my-cards" class="back">返回我的卡片</a>

    {% if card.is_expired() %}
        <div class="status expired">● 已過期</div>
    {% else %}
        <div class="status">● 有效卡片</div>
    {% endif %}

    {% if !card.is_expired() && card.wallet_qr_code.is_some() %}
        {% let cid_present = card.wallet_cid.is_some() %}
        <section class="credential-status" data-credential-status data-poll-url="/cards/{{ card.id }}/poll-credential" data-cid-present="{{ cid_present }}" data-max-polls="150">
            <div class="status-indicator">
                <span class="spinner-dot {% if cid_present %}is-hidden{% endif %}" data-role="spinner"></span>
                <span class="status-text" data-role="status-text">
                    {% if cid_present %}
                        憑證已發行！ ✓
                    {% else %}
                        等待皮夾掃描...
                    {% endif %}
                </span>
            </div>
            <div class="status-details">
                <p class="status-instructions">
                    {% if cid_present %}
                        憑證已在您的數位皮夾中準備就緒。
                    {% else %}
                        請使用數位皮夾應用程式掃描 QR Code。
                    {% endif %}
                </p>
                <p class="poll-info" data-role="poll-info">
                    {% if cid_present %}
                        憑證已準備就緒。
                    {% else %}
                        檢查狀態中...
                    {% endif %}
                </p>
            </div>
        </section>
    {% endif %}

    <div class="card-display">
        <div class="membership-level">{{ card.membership_level_label }}</div>

        {% if card.is_expired() %}
            <div class="qr-code placeholder expired">
                <div class="placeholder-icon">⨯</div>
                <div class="placeholder-text">卡片已過期</div>
            </div>
        {% else if let Some(qr_code) = card.wallet_qr_code.as_deref() %}
            {% if card.wallet_cid.is_none() %}
                <div class="qr-code">
                    <img src="{{ qr_code }}" alt="數位皮夾 QR Code" />
                </div>
                <div class="scan-instruction">使用數位皮夾掃描</div>
            {% else %}
                <div class="qr-code placeholder">
                    <div class="placeholder-icon">✓</div>
                    <div class="placeholder-text">憑證已發行</div>
                </div>
            {% endif %}
        {% else %}
            <div class="qr-code placeholder">
                <div class="placeholder-text">QR Code 無法使用</div>
            </div>
        {% endif %}
    </div>

    <div class="info-grid">
        <div class="info-item">
            <div class="info-label">已確認</div>
            <div class="info-value">{{ card.membership_confirmed_at.format("%Y-%m-%d %H:%M UTC") }}</div>
        </div>
        <div class="info-item">
            <div class="info-label">已發行</div>
            <div class="info-value">{{ card.issued_at.format("%Y-%m-%d %H:%M UTC") }}</div>
        </div>
        {% if let Some(expires_at) = card.expires_at %}
        <div class="info-item">
            <div class="info-label">到期日</div>
            <div class="info-value">{{ expires_at.format("%Y-%m-%d") }}</div>
        </div>
        {% endif %}
        <div class="info-item" style="grid-column: 1 / -1;">
            <div class="info-label">卡片 ID</div>
            <div class="info-value">{{ card.id }}</div>
        </div>
    </div>

    <div class="actions">
        {% if card.wallet_cid.is_none() %}
            {% if let Some(deep_link) = card.wallet_deep_link.as_deref() %}
                <a href="{{ deep_link }}" class="button">在數位皮夾應用程式中開啟</a>
            {% endif %}
        {% endif %}
        <a href="/cards/my-cards" class="button secondary">查看所有卡片</a>
        <button type="button" class="button danger" data-delete-card="{{ card.id }}">刪除卡片</button>
    </div>
{% endblock %}

{% block extra_scripts %}
    <script src="/static/js/credential-polling.js" defer></script>
    <script src="/static/js/card-delete.js" defer></script>
{% endblock %}
